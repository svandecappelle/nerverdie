{% extends "base_layout.html" %} {% block content %}
<div class="row">
    {% for metric in single_metrics %}
        {% if metric.screen and metric.screen.get('size') %}
            <div class="col s12 m6 l{{ metric.screen.get('size') }}">
        {% else %}
            <div class="col s12 m6 l1">
        {% endif %}
        <div class="card blue-grey darken-1">
            <!--<a class="btn-floating waves-effect waves-light top-right absolute" id="{{ metric.title.replace(' ','-') }}-refresh"><i class="material-icons">refresh</i></a>-->
            <i class="white-text waves-effect waves-light top-right absolute material-icons" id="{{ metric.title.replace(' ','-') }}-refresh">refresh</i>

            <div class="card-content white-text">
                <small class="truncate">{{ metric.title }}</small>    
                <div id="{{ metric.title.replace(' ','-') }}">
                    {% if metric.api %}
                        <script type='text/javascript'>
                            {
                                function load() {
                                    $.get("{{ metric.api }}").done((value)=>{
                                        var parsed_value = value;
                                        {% if metric.value %}
                                            var parser = new MetricParser(value);
                                            parsed_value = parser.parse('{{ metric.value }}');
                                        {% endif %}
                                        {% if metric.formatter %}
                                            {% if metric.formatter_opts %}
                                                parsed_value = new Formatter('{{ metric.formatter }}', parsed_value).format({{ metric.formatter_opts | tojson | safe }});
                                            {% else %}
                                                parsed_value = new Formatter('{{ metric.formatter }}', parsed_value).format();
                                            {% endif %}
                                        {% endif %}
                                        $("#{{ metric.title.replace(' ','-') }}").text(parsed_value);
                                    });
                                }

                                $("#{{ metric.title.replace(' ','-') }}-refresh").click(() => {
                                    load();
                                });
                                load();
                            }
                        </script>
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% for metric in timed_metrics %}
        {% if metric.screen and metric.screen.get('size') %}
            <div class="col s12 m6 l{{ metric.screen.get('size') }}">
        {% else %}
            <div class="col s12 m12 l6">
        {% endif %}

        <div class="card">
            <div class="card-content">
                <small class="truncate">{{ metric.options.title }}</small>
                <i class="waves-effect waves-light top-right absolute material-icons" id="{{ metric.options.title.replace(' ','-') }}-refresh">refresh</i>
                <div id="{{ metric.options.title.replace(' ','-') }}">
                    <script>
                        var chart = new Chart("{{metric.options.title.replace(' ', '-') }}");
                        {% if metric.options %}
                            chart.build('{{ metric.series }}', '{{ metric.api }}', {{ metric.options | tojson | safe }});
                        {% else %}
                            chart.build('{{ metric.series }}', '{{ metric.api }}', { title: "" });
                        {% endif %}
                        
                        </script>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% endblock %}